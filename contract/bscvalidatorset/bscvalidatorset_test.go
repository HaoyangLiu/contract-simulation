package bscvalidatorset

import (
	"context"
	"encoding/hex"
	"fmt"
	"github.com/ethereum/go-ethereum/common"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/assert"

	cmm "github/HaoyangLiu/contract-simulation/contract/common"
)

var account, _ = cmm.FromHexKey("B7F5FE087D796A24E7D1215DDF809F101B3147CB8DB0B5B869A5CD7AFDEF9B16")
var bscvalidatorsetABI, _ = abi.JSON(strings.NewReader(BscvalidatorsetABI))

func TestSimulateBSCValidatorPackage(t *testing.T) {
	client, err := ethclient.Dial(cmm.DevEndpoint)
	assert.NoError(t, err)

	nonce, err := client.PendingNonceAt(context.Background(), account.Addr)
	assert.NoError(t, err)
	gasPrice, err := client.SuggestGasPrice(context.Background())
	assert.NoError(t, err)
	auth := bind.NewKeyedTransactor(account.Key)
	auth.Nonce = big.NewInt(int64(nonce))
	auth.Value = big.NewInt(0)
	auth.GasPrice = gasPrice
	auth.GasLimit = 4700000

	//value, _ := hex.DecodeString("00b71b214cb885500844365e95cd9942c7276e7fd8d22ca3ba2141d23adab65ce4940eb7665ea2b6a750d5a81af468238ab84dbcd277ae38abcb3c8ae8000003a3529440001284214b9b9c85549ab3d2b972df0deef66ac2c96ddf42a51534fc98d0c0a3b42c963cace8441ddf53a9e6a64992ffce817b7e973a8df704b5058f30000002ba7def3000a2959d3f95eae5dc7d70144ce1b73b403b7eb6e08081ef03f1d9e0bb4a5bf38f16285c879299f07f28b91b6d858b23bca725e4d9f5ee58bb707cf8ce000002ba7def3000980a75ecd1309ea12fa2ed87a8744fbfc9b863d5cc6ac05c95a99c1f7b5f88de0e3486c82293b27023b74f637dcaa5890f255f2643ea4871a19ddc0c000002ba7def300035552c16704d214347f29fa77f77da6d75d7c752dc4973e838e3949c77aced16ac2315dc2d7ab111d124b6b49b4bbe4de2cebedd15221bc8b2bfd7a3000002ba7def3000f474cf03cceff28abc65c9cbae594f725c80e12de61a183325a18a173319dd8e19c8d069459e2175f9a52e8a2977f57e7df78d87ca52f6d7ddbd6d3d000002ba7def3000")
	data, _ := hex.DecodeString("d81698790000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000007cc190000000000000000000000000000000000000000000000000000000000000eb7b51d0ae40e0ab8020a02080a121242696e616e63652d436861696e2d4e696c651899981f220c08fcf5bef905109fa791be0130f5243a480a2096e03d898c8f283edb34ba0cf0a601cdee3d28e8b66d5fe0b049f60539f770821224080112203eb7b2dcc0d876883a9490441fbbaad6f80c40aea08b3e2d8b3fc7d50029b01f4220771fd3045eba1be9fc3d96c6442cfb401e736e2e9fd3f20ad45abc68d87a2cdd522089496eba7b813d8eb37621a6983f05e98801eff557b3ba1c79872f27db06bb8a5a2089496eba7b813d8eb37621a6983f05e98801eff557b3ba1c79872f27db06bb8a6220294d8fbd0b94b767a7eba9840f299a3586da7fe6b5dead3b7eecba193c400f936a203bef2c64bcd05ad9bfc6a2faaaf49dc375f7d14ed9743d642ed4a413bd585655820114d648a5b9066cd69dfb392ee3c297ac0ddf5528eb12a60c0a480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc912b60108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef9051086cbaaf501321428d2cf7cd695dafd4f190f761b9a2dfd9018448c4240d1ea67d96b2931255140c61f23efa7307e75419fdac07f22eea894bace7a565a99694ddce780ad71807d3eeae9aab06c01920530d3253f1412ea7e869ab5d10612b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef90510e48ca4eb0132143b9f8c187425b43e60515d62cc91288c850e90f938014240c1b18b8c9342008130618f4c940396fcc11f68ecde2305c393e02c6e66b36a53e81eea9d672710a787d7b50bda182789ed2fd8b8558da028cdd08ab2e9c2da0612b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef90510abf78bf80132143bc75b1496384e3208c088294c7d210bac1b3e4138024240ed2ddad60abe313c24f04e72498f06bd7d25229a247b7e0390d2495b1e057a2f58be828734d68409b01c3407bf23b4be5ba977ec446fdad34c9b360fbc7ab10b12b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fcf5bef905109fa791be01321466acc822ffc6826d4214ab8ae507222b7485783138034240b791c49e86f806fa67acbe7a186f03aedd731e25ca4b2b698af590d3906e0f6762f98953819d4463e9a96f98383e0daca264329320c5bb06e8609e4769afea0912b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef9051087c2f5f701321489a5cd59d419a0d18ff18bed87f1ad54627a4f2d3804424058b5decdcac109534bf66f73cc7eccd96f45dcc6eb2972b3a041240475e6ed97d9d8ceb9224df2da0c0c43351e1a75c1acf91e9b52914f0327360c39cc38870412b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08d9c89cfa0510fddbbaad033214d648a5b9066cd69dfb392ee3c297ac0ddf5528eb38054240ebe6d4ca683fdb423afa797d996eb9b6901e274456f0f0e2643af912b2330f5911bca71a01d040d1b83472221c8a859c3ad47827d1bc3b94c28029ced935c10a1200120012b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef905108df7d692023214e77f0836b895691f6cfe85dae991a21a6ad94a0338084240d3cae65198c59fc882e8dfae96dc32d1af5d413f4fca4a98682c755d359df2ea65988aceaa03a546196b9aa7c9ed4584f9452ee772747e250e70137d9e781b0812b80108021099981f22480a20d1dbe49eaf23d93972b995ad8c0124e4416d319b18bb94310129acecc5d96df81224080112207d0afcfb797e611fdedec6baa3466a8b309fe6445739926e43b7d14906c0afc92a0c08fef5bef9051080defcea013214ea740e1e49c32156ad56fcb9764d178bd08d0d6838094240c964c8a7a414c7aa40472a5cb406d0971624530f2298605e767043505d7a35f871912e92b62ecdc3947b0c33d891137ee4c91755562676d474be828b5b91cd04120012a4070a4f0a1428d2cf7cd695dafd4f190f761b9a2dfd9018448c12251624de6420b4a3dfe007b6270d81a63acbb4432a0fc884fee651e4fbc4c40150d8f99c43f51880a094a58d1d2080c0b58cfbdcfdffff010a4b0a143b9f8c187425b43e60515d62cc91288c850e90f912251624de6420cad7bd770c1dd0397e33e9d9d3add62d34abd8a30dc5b616525baaaf8df417d61880a094a58d1d2080a094a58d1d0a4b0a143bc75b1496384e3208c088294c7d210bac1b3e4112251624de642034044e0606196391d09dffeb7671a2a2be43abe37f684ef406545660882e2d0b1880a094a58d1d2080a094a58d1d0a4b0a1466acc822ffc6826d4214ab8ae507222b7485783112251624de642073e0b195030b79529b8fedd12106ab9523ba23b1510c9bc0cead1d8265dc05c01880a094a58d1d2080a094a58d1d0a4b0a1489a5cd59d419a0d18ff18bed87f1ad54627a4f2d12251624de642045356ac26abb1ca953a2bdf0e28229f70b2c1c7b85f837f072cc604d0d4779d51880a094a58d1d2080a094a58d1d0a4b0a14d648a5b9066cd69dfb392ee3c297ac0ddf5528eb12251624de64203b22dfb3b0d3764283106bc93fd24b5f4ee1a955f04e36ce5da6a014d1dcd18b1880a094a58d1d2080a094a58d1d0a4b0a14d7064eb07625ae48ac1754d0bb666d3066f594d512251624de6420ae4ccacf75b148552a3a5bd5b410ee4381a288d44895218246e4762d5e8dfff41880a094a58d1d2080a094a58d1d0a4b0a14d8ddd68cc695835a499c671a469a6f38834d34f912251624de642071559e8cb1d83cad1db470e29fc45fa1c42724820545166b49a72ab2ba223dd21880a094a58d1d2080a094a58d1d0a4b0a14e77f0836b895691f6cfe85dae991a21a6ad94a0312251624de6420319dac1531d185b9f4542749cd115af5970c717cee23d730dd98737de4fbcc891880a094a58d1d2080a094a58d1d0a4b0a14ea740e1e49c32156ad56fcb9764d178bd08d0d6812251624de642078a98a1177c61a44306387dd986f056d3460ae8bf05980b3c20e5c5ddd81ca6e1880a094a58d1d2080a094a58d1d0a4b0a14f15ab82564d6f450ca6f30a074568a5e6dee7b9b12251624de6420df33205d0974d06f3f5d32e6fd98e5debd7ec39a796455f93c63aeef0dadb31a1880a094a58d1d2080a094a58d1d124f0a1428d2cf7cd695dafd4f190f761b9a2dfd9018448c12251624de6420b4a3dfe007b6270d81a63acbb4432a0fc884fee651e4fbc4c40150d8f99c43f51880a094a58d1d2080c0b58cfbdcfdffff011aa4070a4f0a1428d2cf7cd695dafd4f190f761b9a2dfd9018448c12251624de6420b4a3dfe007b6270d81a63acbb4432a0fc884fee651e4fbc4c40150d8f99c43f51880a094a58d1d2080c0b58cfbdcfdffff010a4b0a143b9f8c187425b43e60515d62cc91288c850e90f912251624de6420cad7bd770c1dd0397e33e9d9d3add62d34abd8a30dc5b616525baaaf8df417d61880a094a58d1d2080a094a58d1d0a4b0a143bc75b1496384e3208c088294c7d210bac1b3e4112251624de642034044e0606196391d09dffeb7671a2a2be43abe37f684ef406545660882e2d0b1880a094a58d1d2080a094a58d1d0a4b0a1466acc822ffc6826d4214ab8ae507222b7485783112251624de642073e0b195030b79529b8fedd12106ab9523ba23b1510c9bc0cead1d8265dc05c01880a094a58d1d2080a094a58d1d0a4b0a1489a5cd59d419a0d18ff18bed87f1ad54627a4f2d12251624de642045356ac26abb1ca953a2bdf0e28229f70b2c1c7b85f837f072cc604d0d4779d51880a094a58d1d2080a094a58d1d0a4b0a14d648a5b9066cd69dfb392ee3c297ac0ddf5528eb12251624de64203b22dfb3b0d3764283106bc93fd24b5f4ee1a955f04e36ce5da6a014d1dcd18b1880a094a58d1d2080a094a58d1d0a4b0a14d7064eb07625ae48ac1754d0bb666d3066f594d512251624de6420ae4ccacf75b148552a3a5bd5b410ee4381a288d44895218246e4762d5e8dfff41880a094a58d1d2080a094a58d1d0a4b0a14d8ddd68cc695835a499c671a469a6f38834d34f912251624de642071559e8cb1d83cad1db470e29fc45fa1c42724820545166b49a72ab2ba223dd21880a094a58d1d2080a094a58d1d0a4b0a14e77f0836b895691f6cfe85dae991a21a6ad94a0312251624de6420319dac1531d185b9f4542749cd115af5970c717cee23d730dd98737de4fbcc891880a094a58d1d2080a094a58d1d0a4b0a14ea740e1e49c32156ad56fcb9764d178bd08d0d6812251624de642078a98a1177c61a44306387dd986f056d3460ae8bf05980b3c20e5c5ddd81ca6e1880a094a58d1d2080a094a58d1d0a4b0a14f15ab82564d6f450ca6f30a074568a5e6dee7b9b12251624de6420df33205d0974d06f3f5d32e6fd98e5debd7ec39a796455f93c63aeef0dadb31a1880a094a58d1d2080a094a58d1d124f0a1428d2cf7cd695dafd4f190f761b9a2dfd9018448c12251624de6420b4a3dfe007b6270d81a63acbb4432a0fc884fee651e4fbc4c40150d8f99c43f51880a094a58d1d2080c0b58cfbdcfdffff01000000000000000000")
	//
	// data, err := bscvalidatorsetABI.Pack("handleSynPackage", 8, msgBytes)
	//assert.NoError(t, err)

	//data, _ := hex.DecodeString("e695c4ae00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000002c6f100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000199001284214b9b9c85549ab3d2b972df0deef66ac2c96ddf42a51534fc98d0c0a3b42c963cace8441ddf2ae1ace6a7e31c76ee3c7d2f0b5977c21d5a2a3a000006d23ad5f800b71b214cb885500844365e95cd9942c7276e7fd8d22ca3ba2141d23adab65ce4940eb7665ea2b6a7299de25a1a19c032d70abf6a467ab86d63632fe20000048c27395000a2959d3f95eae5dc7d70144ce1b73b403b7eb6e08081ef03f1d9e0bb4a5bf38f16285c879299f07f51f1512d6bfac004c862e761c43ad87dd8235dc40000048c27395000980a75ecd1309ea12fa2ed87a8744fbfc9b863d5cc6ac05c95a99c1f7b5f88de0e3486c82293b2705aff052393bb463160625c9e723ec8b709c279060000048c2739500035552c16704d214347f29fa77f77da6d75d7c752dc4973e838e3949c77aced16ac2315dc2d7ab111a86cfcf4753a5df58d89bd6524f69b0e1ae072a90000048c27395000f474cf03cceff28abc65c9cbae594f725c80e12de61a183325a18a173319dd8e19c8d069459e217580ed64cac70616c612b08e3ffb86761175e2c8370000048c273950000000000000000000000000000000000000000000000000000000000000000000000000000003e60ae0020a066961766c3a76120e00000100020800000000000000001ac502c3020ac0020a2a0807103b1898860722208ef34163fcc4dfce9f03885d6c20fee17a811f894ac98964f3c592a269bb40f00a2a080610231898860722205f342ec72bfcb94e84c090f3a01ec91b14a7b39caa09e54f1b29af1e9fb9c8a80a2a080510171898860722208aa6803662ce59b657c597cf2a986f7d6628cff0d86c905f008f7edbbc7103670a2a0804100b189886072220aa1cf42bcb2e402e0a2a96d6ddc3904edf46f23c37245922bd01f33f2b6d55b60a2a08031005189886072a20eac5f0bb28be3ada3ba9791d5d576be1f1c7ee2c04deaca2dc3864b1650369d70a2a08011002189886072220b6daa94733d00ccc6ae6562980041aeb24ac5854522b796aeb71852d9e56b7261a360a0e00000100020800000000000000001220afa0b4567653382be12fc062db374feef26095c877d9b5ff2b6129281e0e3fa6189886070a80050a0a6d756c746973746f726512036962631aec04ea040ae7040a2e0a02736312280a2608f08d0b1220e3f2fbbe55331ac6f58a0ab0be79c61d5dc6717f1be56e23ea6e645edd9cce4e0a0e0a046d61696e12060a0408f08d0b0a0f0a05706169727312060a0408f08d0b0a2f0a0364657812280a2608f08d0b12204ef45e955948474a310ae01b0114aec3f130e6acf474e40b8f3c8dba51df8e190a100a0662726964676512060a0408f08d0b0a320a066f7261636c6512280a2608f08d0b1220f3b96e7fe8a0188e06d532a3cb5ecfb0d3cca886289e395038ccd4f83b4a16a90a320a06746f6b656e7312280a2608f08d0b12204ecd0ae0b234ce82872b1013227f965745413598e576b843d8c6273314a648080a310a057374616b6512280a2608f08d0b1220f9b283716d4b22382201b7ed755088cceb8330428c1272f58cdcb6103ff952810a340a08736c617368696e6712280a2608f08d0b1220b06f6d7d51736641b566f007ae33f3324901f52c33a1a932e1b78f170a0c30c20a2f0a0369626312280a2608f08d0b1220ab3f69b05146ef2084fbb8593c23f5501f621f49c110939af655409f82241cfb0a2f0a0361636312280a2608f08d0b12203d6d2ecf801680022ea7663ac3fcc4cb77af96c33d7aae29aa470a8f20178d920a0d0a0376616c12060a0408f08d0b0a320a06706172616d7312280a2608f08d0b1220053fe33fca051769ee4b00129c1dbd6d1c334cb94f3864d7f2a7c4fcba3b56720a130a0974696d655f6c6f636b12060a0408f08d0b0a2f0a03676f7612280a2608f08d0b122047d9b06442e048391331c8ddefc8d655e37b2b57b2f2e4e0034e735d3a1fefe90a150a0b61746f6d69635f7377617012060a0408f08d0b0000000000000000000000000000000000000000000000000000")
	msg := ethereum.CallMsg{
		From:     common.HexToAddress("0x37b8516a0f88e65d677229b402ec6c1e0e333004"),
		To:       &cmm.TendermintLightClient,
		Gas:      auth.GasLimit,
		GasPrice: auth.GasPrice,
		Value:    auth.Value,
		Data:     data,
	}

	res, err := client.CallContract(context.Background(), msg, nil)

	fmt.Println(err)
	fmt.Println(string(res))
}

