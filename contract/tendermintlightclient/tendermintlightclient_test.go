package tendermintlightclient

import (
	"context"
	"encoding/hex"
	"fmt"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/assert"

	cmm "github/HaoyangLiu/contract-simulation/contract/common"
)

var account, _ = cmm.FromHexKey("B7F5FE087D796A24E7D1215DDF809F101B3147CB8DB0B5B869A5CD7AFDEF9B16")
var tendermintlightclientABI, _ = abi.JSON(strings.NewReader(TendermintlightclientABI))

func TestSimulateSyncTendermintHeader(t *testing.T) {
	client, err := ethclient.Dial("http://localhost:8545")
	assert.NoError(t, err)

	nonce, err := client.PendingNonceAt(context.Background(), account.Addr)
	assert.NoError(t, err)

	gasPrice, err := client.SuggestGasPrice(context.Background())
	assert.NoError(t, err)

	auth := bind.NewKeyedTransactor(account.Key)
	auth.Nonce = big.NewInt(int64(nonce))
	auth.Value = big.NewInt(0)
	auth.GasPrice = gasPrice
	auth.GasLimit = 4700000

	//headerBytes, _ := hex.DecodeString("85080a84030ab5020a02080a121342696e616e63652d436861696e2d4b6f6e676f18f7d80f220c08ad82eaf50510fff9dbe2022a480a200a2548ec462885cc12ce872076c675b5661754a9d49d4c3735b8c7c80c0103b01224080112209468153baca743d8473e34d00419c2e1d8ecd055b0cae304c7ea352142a585ac32209302e1110865dffd1f7c95aa6ebff662e45b3e7d105bb97b3406aae6dfce0fdc4220aea1ac326886b992a991d21a6eb155f41b77867cbf659e78f31d89d8205122a84a20aea1ac326886b992a991d21a6eb155f41b77867cbf659e78f31d89d8205122a85220294d8fbd0b94b767a7eba9840f299a3586da7fe6b5dead3b7eecba193c400f935a20267e70700ed59daa8b352ead6ffa788e1b21ae3b7341f114123e5fbe4414a96c7214f42f1d05ac568d12e26b9655395e7fbbd46bc5bb124a1a480a20f6b7938000ff78665c07521c0159992f3205faa5056fb6f537203271e317a9d51224080112206d3d6b94ed0099cb4bfc864d292eae0b6c428889f032db275bf0816aa689f60712bc020a4f0a149ccddd479c0ad8dcd01d754dd95fe15384e8bbdc12251624de64204d1be64f0e9a466c2e66a53433928192783e29f8fa21beb2133499b5ef770f601880a094a58d1d2080c0d7b5e5c5ffffff010a4b0a14d4cecef238e778c7063552c3a7ab95da35c3fb4712251624de642099308aa365c40554bc89982af505d85da95251445d5dd4a9bb37dd2584fd92d31880a094a58d1d2080a094a58d1d0a4b0a14f42f1d05ac568d12e26b9655395e7fbbd46bc5bb12251624de642001776920ff0b0f38d78cf95c033c21adf7045785114e392a7544179652e0a6121880a094a58d1d2080a094a58d1d124f0a149ccddd479c0ad8dcd01d754dd95fe15384e8bbdc12251624de64204d1be64f0e9a466c2e66a53433928192783e29f8fa21beb2133499b5ef770f601880a094a58d1d2080c0d7b5e5c5ffffff011abc020a4f0a149ccddd479c0ad8dcd01d754dd95fe15384e8bbdc12251624de64204d1be64f0e9a466c2e66a53433928192783e29f8fa21beb2133499b5ef770f601880a094a58d1d2080c0d7b5e5c5ffffff010a4b0a14d4cecef238e778c7063552c3a7ab95da35c3fb4712251624de642099308aa365c40554bc89982af505d85da95251445d5dd4a9bb37dd2584fd92d31880a094a58d1d2080a094a58d1d0a4b0a14f42f1d05ac568d12e26b9655395e7fbbd46bc5bb12251624de642001776920ff0b0f38d78cf95c033c21adf7045785114e392a7544179652e0a6121880a094a58d1d2080a094a58d1d124f0a149ccddd479c0ad8dcd01d754dd95fe15384e8bbdc12251624de64204d1be64f0e9a466c2e66a53433928192783e29f8fa21beb2133499b5ef770f601880a094a58d1d2080c0d7b5e5c5ffffff01,")
	//
	//data, err := tendermintlightclientABI.Pack("syncTendermintHeader", headerBytes, uint64(2))
	//assert.NoError(t, err)
	data, err := hex.DecodeString("d8169879000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000b9000000000000000000000000000000000000000000000000000000000000035cda060ab9040ab1020a02080a120d626e62636861696e2d3130303018b901220c08b09f9ef9051090c3e59f0230033a480a20e4c9c84b5aba3be152335fcce442b5e09de7992305b4dc9d077d10c1b20d1ad01224080112207d294bda9bbb4325458a465310ea85571bd2ab8a43a5ca6794c61effaffb1ec64220d2610419cb7d2c5c2b00a10e355d3759df1ca2fbaf8dde24916ee1430f5bbb5d52207e2802a4d40cafa0948609ea7bb6b4979504f95a3629c0155ca1e41cb90e5e4d5a207e2802a4d40cafa0948609ea7bb6b4979504f95a3629c0155ca1e41cb90e5e4d6220294d8fbd0b94b767a7eba9840f299a3586da7fe6b5dead3b7eecba193c400f936a2051000257eea3c7943f9a732130b2b04c77558600f7ec4d4635e18dc09ec81dff820114253bae9214bfee56e1e88f692390a32346504dd71282020a480a205d53cf3e39868d9c60c773432e2832519ad49349af138cbf8a0969cc8997d60c1224080112207bc8d70517136aff0054ef1eca18aa09fa2237cdc549fdb5faa4767af77f08f712b501080210b90122480a205d53cf3e39868d9c60c773432e2832519ad49349af138cbf8a0969cc8997d60c1224080112207bc8d70517136aff0054ef1eca18aa09fa2237cdc549fdb5faa4767af77f08f72a0c08b19f9ef90510f09b82b3023214253bae9214bfee56e1e88f692390a32346504dd742403d5bd6b7ecb3cbd5d13cb0520d391df3ceab67e6d08ad814517fc45017342a38e978f4624af32c0486ec68988d65ebb310b2a299b52a683a55b82be34b434c05128c010a440a14253bae9214bfee56e1e88f692390a32346504dd712251624de64207f4a25d4bdbb6a583695900c2b8b30e8af67e4c115ea9b07180f14c94223bc831880a094a58d1d12440a14253bae9214bfee56e1e88f692390a32346504dd712251624de64207f4a25d4bdbb6a583695900c2b8b30e8af67e4c115ea9b07180f14c94223bc831880a094a58d1d1a8c010a440a14253bae9214bfee56e1e88f692390a32346504dd712251624de64207f4a25d4bdbb6a583695900c2b8b30e8af67e4c115ea9b07180f14c94223bc831880a094a58d1d12440a14253bae9214bfee56e1e88f692390a32346504dd712251624de64207f4a25d4bdbb6a583695900c2b8b30e8af67e4c115ea9b07180f14c94223bc831880a094a58d1d00000000")
	assert.NoError(t, err)

	msg := ethereum.CallMsg{
		From:     auth.From,
		To:       &cmm.TendermintLightClient,
		Gas:      auth.GasLimit,
		GasPrice: auth.GasPrice,
		Value:    auth.Value,
		Data:     data,
	}

	res, err := client.CallContract(context.Background(), msg, nil)

	fmt.Println(err)
	fmt.Println(string(res))
}
